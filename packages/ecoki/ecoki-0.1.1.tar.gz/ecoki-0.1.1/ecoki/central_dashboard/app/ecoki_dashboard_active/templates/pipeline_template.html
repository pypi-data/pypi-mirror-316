{% extends 'app_base.html' %}
{% load static %}


{% if user.is_authenticated %}

    {% block content_wrapper %}
        <div class="content-wrapper ecoki-background" style="min-height: 288.4px;">
            <section class="content-header">
                <div class="container-fluid">
                  <div class="row mb-2">
                      <h1 style="margin-right: 30px;">Pipeline "{{ name }}"</h1>                    

                      <!-- Displaying the Run button for pipeline visualisation--> 
                      <a href="/active/pipeline/{{ name }}/{{ current_bb }}/visualize/">
                        <button type="button" class="btn btn-success btn-sm {% if item in request.path %}active{% endif %}" style="color:white; margin-right: 30px;">
                          Run pipeline                                               
                        </button> 
                      </a>

                      <!-- Displaying the Run Configure button for GUI visualisation--> 
                      <a href="/active/pipeline/{{ name }}/{{ current_bb }}/config_gui/">
                        <button type="button" class="btn btn-success btn-sm {% if item in request.path %}active{% endif %}" style="color:white; margin-right: 30px;">
                          Configure run pipeline                                               
                        </button> 
                      </a>

                      <!-- Displaying the configure button for pipeline--> 
                      <a href="/active/pipeline/{{ name }}/{{ current_bb }}/yes/no/configure/">
                        <button type="button" class="btn btn-success btn-sm {% if item in request.path %}active{% endif %}" style="color:white; margin-right: 30px;">
                          Configure pipeline structure                                               
                        </button> 
                      </a>

                      <!-- Displaying the save-to-duplicate button for pipeline--> 
                      <a href="/active/pipeline/{{ name }}/{{ current_bb }}/yes/yes/configure/">
                        <button type="button" class="btn btn-success btn-sm {% if item in request.path %}active{% endif %}" style="color:white; margin-right: 30px;">
                          Save to duplicate pipeline                                              
                        </button> 
                      </a>

                      {% if pipeline_type == "custom" %}
                        <!-- Displaying the save button for pipeline--> 
                        <a href="/active/pipeline/{{ name }}/{{ current_bb }}/save/">
                          <button {% if is_interactive == False %}disabled{% endif %} type="button" class="btn btn-success btn-sm {% if item in request.path %}active{% endif %}" style="color:white; margin-right: 30px;">
                            Save pipeline                                               
                          </button> 
                        </a>
                      {% endif %}

                      <!-- Displaying the delete button for pipeline--> 
                      <a href="/active/pipeline/{{ name }}/{{ current_bb }}/delete/">
                        <button type="button" class="btn btn-success btn-sm {% if item in request.path %}active{% endif %}" style="color:white; margin-right: 30px;">
                          Delete pipeline                                               
                        </button> 
                      </a>

                  </div>
                </div><!-- /.container-fluid -->
            </section>
            <section class="content" style = "display:inline block">
              <nav aria-label="Page navigation example" style="overflow-x:auto">
                  <ul class="pagination pagination-lg justify-content-left">
                    {% for number, bbname, icon in bb_ids_names_text_icons %}
                      <li class="page-item {% if number == url %}active{% endif %}">
                        <a class="page-link" href="/active/pipeline/{{ name }}/{{ number }}/" style="display: flex; flex-direction: row">{{ bbname }}
                          {% with 'ecoki/img/'|add:icon|add:'.png' as bb_status %}
                            <img src="{% static bb_status %}" style="width:25px; height:25px; margin-left:10px; border-radius:60%; margin-top:5px;">
                          {% endwith %}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </nav>

                <div class="card card-success">
                  <div class="card-header">
                    <h3 class="card-title">Building Block Description</h3>

                    <div class="card-tools">
                      <!-- This will cause the card to maximize when clicked -->
                      <button type="button" class="btn btn-tool" data-card-widget="maximize"><i class="fas fa-expand"></i></button>
                      <!-- This will cause the card to collapse when clicked -->
                      <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                      <!-- This will cause the card to be removed when clicked -->
                      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                    <!-- /.card-tools -->
                  </div>
                  <!-- /.card-header -->
                  <div class="card-body">
                    "{{current_description}}"
                      <!--\n Test:
                  </div>
                  <!-- /.card-body -->
                </div>
                <!-- /.card -->

                {% if current_html %}
                  <div class="card card-success">
                    <div class="card-header">
                      <h3 class="card-title">{% if visualizer %}Building Block Visualizer{% else %}Interactive Configuration Assistant{% endif %}</h3>

                      <div class="card-tools">
                        <!-- This will cause the card to maximize when clicked -->
                        <button type="button" class="btn btn-tool" data-card-widget="maximize"><i class="fas fa-expand"></i></button>
                        <!-- This will cause the card to collapse when clicked -->
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        <!-- This will cause the card to be removed when clicked -->
                        <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                      </div>
                      <!-- /.card-tools -->
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body" id="config_displayer">
                       <span id="save-msg" style="width:600px; height:35px; text-align:center; background-color:light-blue; color:green; display:none"></span>
                       <span id="loading-msg" style="width:600px; height:35px; text-align:center; color:black"><b>Loading building block content with 15 seconds timeout.....</b></span>
                       <!--Trying to embed src="{{current_html}}"-->
                       <!--<iframe src="http://localhost:3000/d-solo/OqvMC-j7k/coffee-beans-roasting-dataset?orgId=1&from=1420066800000&to=1420131600000&panelId=2" width="450" height="200" frameborder="0"></iframe>-->
                       <object data="http://{{current_html}}" id="curr_html" width="100%" height="800" onload="cancelTimeout()" onerror="checkerror()">
                         Building block content could not be loaded. Please try again.
                       </object>
                      </div>
                    <!-- /.card-body -->
                  </div>
                {% endif %}
                </div>

            </section>

        </div>
    {% endblock %}

    {% block extra_foot %}

            <script src="/static/admin-lte/dist/js/adminlte.min.js"></script>
            <script>
              var curr_html_link = '{{current_html}}' 
              if(curr_html_link) {
                var reload = true              
                
                iframeLoadTimeout = setTimeout(() => { reload = false; }, 15000);

                checkerror=function(){
                  if(reload) {
                    document.getElementById('curr_html').remove()
                    var divObj = document.getElementById('config_displayer');
                    divObj.innerHTML += '<object data="http://{{current_html}}" id="curr_html" width="100%" height="800" onload="cancelTimeout()" onerror="checkerror()">' +
                                        '<b>Building block content could not be loaded. Please try again.</b>'
                                        '</object>'
                  } else {
                    document.getElementById('loading-msg').remove();
                  }
                }
              
                cancelTimeout=function(){
                  try {
                    reload = false
                    document.getElementById('loading-msg').remove();
                    window.clearTimeout(iframeLoadTimeout);
                    var iframe = document.getElementById("curr_html");
                  } catch(e) {}
                }; 
              }  
              
              var save = '{{ save_settings }}';
              if(save == 'yes'){
                document.getElementById("save-msg").style.display="flex";
                document.getElementById("save-msg").innerHTML = "<b>{{ save_message }}</b>";
                setTimeout(function(){
                  document.getElementById("save-msg").style.display="none";
                  },5000);
              }
            </script>    
    {% endblock %}

{% endif %}