"use strict";(self.webpackChunk_jupyter_suggestions_core=self.webpackChunk_jupyter_suggestions_core||[]).push([[759],{759:(e,t,s)=>{s.r(t),s.d(t,{BaseSuggestionsManager:()=>o,COMMAND_IDS:()=>h,CellToolbarMenu:()=>L,ISuggestionsManagerRegistryToken:()=>ue,ISuggestionsModelToken:()=>re,LocalSuggestionsManager:()=>w,SuggestionType:()=>f,SuggestionsManagerRegistry:()=>S,SuggestionsModel:()=>R,SuggestionsPanelWidget:()=>ce,cellModelFromYCell:()=>_,cloneCellModel:()=>C,collapseIcon:()=>g,deleteCellById:()=>v,detectCellChangedEvent:()=>p,expandIcon:()=>d,getCellMap:()=>m,hintIcon:()=>l,locationIcon:()=>c,minimizeIcon:()=>a});var n=s(602);class o{constructor(e){this.name="Base Suggestion Manager",this._suggestionsMap=new Map,this._suggestionChanged=new n.Signal(this),this._isDisposed=!1,this._tracker=e.tracker,this._tracker.widgetAdded.connect(this._notebookAdded,this)}get isDisposed(){return this._isDisposed}get suggestionChanged(){return this._suggestionChanged}dispose(){this._isDisposed||(this._tracker.widgetAdded.disconnect(this._notebookAdded),n.Signal.clearData(this),this._isDisposed=!0)}async getSuggestion(e){const{notebookPath:t,cellId:s,suggestionId:n}=e;if(this._suggestionsMap.has(t)){const e=this._suggestionsMap.get(t);if(e&&e.has(s))return e.get(s)[n]}}_notebookAdded(e,t){t.disposed.connect((e=>{const t=e.context.localPath;this._suggestionsMap.has(t)&&this._suggestionsMap.delete(t)}))}}var i=s(960);const l=new i.LabIcon({name:"jupyter-suggestions:hintIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px"\n  fill="#e8eaed">\n  <rect fill="none" height="24" width="24" y="0" />\n  <path class="jp-icon3" fill="none"\n    d="M7,20h4c0,1.1-0.9,2-2,2S7,21.1,7,20z M5,19h8v-2H5V19z M16.5,9.5c0,3.82-2.66,5.86-3.77,6.5H5.27 C4.16,15.36,1.5,13.32,1.5,9.5C1.5,5.36,4.86,2,9,2S16.5,5.36,16.5,9.5z M21.37,7.37L20,8l1.37,0.63L22,10l0.63-1.37L24,8 l-1.37-0.63L22,6L21.37,7.37z M19,6l0.94-2.06L22,3l-2.06-0.94L19,0l-0.94,2.06L16,3l2.06,0.94L19,6z" />\n</svg>'}),a=new i.LabIcon({name:"jupyter-suggestions:minimizeIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">\n  <path class="jp-icon3" fill="#e8eaed" d="M240-120v-80h480v80H240Z" />\n</svg>'}),d=new i.LabIcon({name:"jupyter-suggestions:expandIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">\n  <path class="jp-icon3" fill="#e8eaed" d="M200-200v-240h80v160h160v80H200Zm480-320v-160H520v-80h240v240h-80Z" />\n</svg>'}),g=new i.LabIcon({name:"jupyter-suggestions:collapseIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">\n  <path class="jp-icon3" fill="#e8eaed" d="M440-440v240h-80v-160H200v-80h240Zm160-320v160h160v80H520v-240h80Z" />\n</svg>'}),c=new i.LabIcon({name:"jupyter-suggestions:locationIcon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed">\n  <path class="jp-icon3" fill="none"\n    d="M480-480q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0 294q122-112 181-203.5T720-552q0-109-69.5-178.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186Zm0 106Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880q127 0 223.5 89T800-552q0 100-79.5 217.5T480-80Zm0-480Z" />\n</svg>'});var r=s(262),u=s(315);const h={addCellSuggestion:"jupyter-suggestions-core:add-cell-suggestion",addDeleteCellSuggestion:"jupyter-suggestions-core:add-delete-cell-suggestion"};function m(e){var t,s;const n={};return[...null!==(s=null===(t=null==e?void 0:e.model)||void 0===t?void 0:t.cells)&&void 0!==s?s:[]].forEach((e=>{n[e.id]=e})),n}function p(e){const{cellsChange:t}=e;if(t){let e,s=!1,n=!1,o=0,i=0;for(const l of t)void 0!==l.delete&&(s=!0,i=l.delete),void 0!==l.insert&&(e=l.insert),void 0!==l.retain&&(n=!0,o=l.retain);if(s)return n&&e?{event:"moved",movedCells:e}:{event:"deleted",deletedIdx:o+i-1}}}function _(e){let t;const{yCell:s,mimeType:n}=e;switch(s.cell_type){case"code":t=new u.CodeCellModel({sharedModel:s}),t.mimeType=n;break;case"markdown":t=new u.MarkdownCellModel({sharedModel:s});break;case"raw":t=new u.RawCellModel({sharedModel:s})}return t}async function v(e){var t;const{cellId:s,defaultCell:n,currentNotebook:o}=e;let i=e.sharedModel;const l=new r.PromiseDelegate;if(o&&(i=null===(t=o.model)||void 0===t?void 0:t.sharedModel),i){let e=-1;const t=i.cells;for(let n=0;n<t.length;n++)if(t[n].getId()===s){e=n;break}if(-1!==e){const t=(s,n)=>{const o=p(n);"deleted"===(null==o?void 0:o.event)&&o.deletedIdx===e&&(l.resolve(!0),i.changed.disconnect(t))};i.changed.connect(t),i.transact((()=>{i.deleteCell(e),1===i.cells.length&&i.insertCell(0,{cell_type:null!=n?n:"code",metadata:"code"===n?{trusted:!0}:{}}),o&&(o.activeCellIndex=e)})),null==o||o.deselectAll()}}else l.resolve(!1);return l.promise}function C(e,t){if(!e)return;let s;const n=e.mimeType;switch(e.type){case"code":s=new u.CodeCellModel;break;case"markdown":s=new u.MarkdownCellModel;break;case"raw":s=new u.RawCellModel}if(!s)throw new Error("Invalid cell type");return s.mimeType=n,s.sharedModel.setSource(null!=t?t:e.sharedModel.getSource()),s}var f;!function(e){e.change="CHANGE",e.delete="DELETE"}(f||(f={}));const b="jupyter_suggestion";class w extends o{constructor(e){super(e),this.sourceLiveUpdate=!1,this.name="Local Suggestion Manager",this._tracker=e.tracker,this._tracker.widgetAdded.connect(this._notebookAdded,this)}async getAllSuggestions(e){var t,s,n;const o=e.context.localPath;if(this._suggestionsMap.has(o))return null!==(t=this._suggestionsMap.get(o))&&void 0!==t?t:new Map;{const t=e.context.model.getMetadata(b);if(t){const i=new Map,l=null!==(n=null===(s=e.content.model)||void 0===s?void 0:s.cells)&&void 0!==n?n:[],a={};for(const e of l)a[e.id]=e;return Object.entries(t).forEach((([e,t])=>{const s={};Object.entries(t).forEach((([e,t])=>{const n=this._deserializedSuggestion(t,a);n&&(s[e]=n)})),i.set(e,s)})),this._suggestionsMap.set(o,i),i}return new Map}}async getSuggestion(e){const{notebookPath:t,cellId:s,suggestionId:n}=e;if(this._suggestionsMap.has(t)){const e=this._suggestionsMap.get(t);if(e&&e.has(s))return e.get(s)[n]}}async addSuggestion(e){const t=r.UUID.uuid4();switch(e.type){case f.delete:case f.change:{const{notebook:s,cell:n,author:o}=e,i=s.context.localPath;this._suggestionsMap.has(i)||this._suggestionsMap.set(i,new Map);const l=this._suggestionsMap.get(i),a=n.model.id;l.has(a)||l.set(a,{});const d=l.get(a),g={originalCellId:a,cellModel:C(n.model),metadata:{author:o},type:e.type};d[t]=g,await this._saveSuggestionToMetadata({notebook:s,cellId:a,suggestionId:t,suggestionContent:g}),this._suggestionChanged.emit({notebookPath:i,cellId:a,suggestionId:t,operator:"added"});break}}return t}async acceptSuggestion(e){var t;const{notebook:s,cellId:n,suggestionId:o}=e,i=s.context.localPath,l=await this.getSuggestion({notebookPath:i,cellId:n,suggestionId:o});if(l&&(null===(t=s.content.model)||void 0===t?void 0:t.cells))switch(l.type){case f.change:{const t=l.cellModel.sharedModel.getSource();for(const o of s.content.model.cells)if(o.id===n)return o.sharedModel.setSource(t),await this.deleteSuggestion(e),!0;break}case f.delete:{const e=s.content,{defaultCell:t}=e.notebookConfig;return await v({currentNotebook:e,cellId:n,defaultCell:t})}}return!1}async deleteSuggestion(e){const{notebook:t,cellId:s,suggestionId:n}=e,o=t.context.localPath;if(this._suggestionsMap.has(o)){const e=this._suggestionsMap.get(o);e&&e.has(s)&&(delete e.get(s)[n],await this._removeSuggestionFromMetadata({notebook:t,cellId:s,suggestionId:n}),this._suggestionChanged.emit({notebookPath:o,cellId:s,suggestionId:n,operator:"deleted"}))}}async updateSuggestion(e){const{notebook:t,cellId:s,suggestionId:n,newSource:o}=e,i=t.context.localPath;if(this._suggestionsMap.has(i)){const e=this._suggestionsMap.get(i);e&&e.has(s)&&e.get(s)[n]&&(await this._updateSuggestionInMetadata({notebook:t,cellId:s,suggestionId:n,newSource:o}),this._suggestionChanged.emit({notebookPath:i,cellId:s,suggestionId:n,operator:"modified"}))}}async _saveSuggestionToMetadata(e){var t,s,n,o;const{notebook:i,cellId:l,suggestionId:a,suggestionContent:d}=e,{originalCellId:g,cellModel:c,metadata:r,type:u}=d,h=null!==(t=i.context.model.getMetadata(b))&&void 0!==t?t:{},m={originalCellId:g,newSource:null!==(n=null===(s=null==c?void 0:c.sharedModel)||void 0===s?void 0:s.getSource())&&void 0!==n?n:"",metadata:r,type:u},p={...h,[l]:{...null!==(o=h[l])&&void 0!==o?o:{},[a]:m}};i.context.model.setMetadata(b,p),await this._saveNotebook(i)}async _saveNotebook(e){e.content.model&&!e.content.model.collaborative&&await e.context.save()}async _removeSuggestionFromMetadata(e){const{notebook:t,cellId:s,suggestionId:n}=e,o=t.context.model.getMetadata(b);o&&o[s]&&(o[s][n]&&delete o[s][n],0===Object.keys(o[s]).length&&delete o[s],t.context.model.setMetadata(b,o),await this._saveNotebook(t))}async _updateSuggestionInMetadata(e){const{notebook:t,cellId:s,suggestionId:n,newSource:o}=e,i=t.context.model.getMetadata(b);i&&i[s]&&i[s][n]&&(i[s][n].newSource=o,t.context.model.setMetadata(b,i),await this._saveNotebook(t))}_deserializedSuggestion(e,t){const{originalCellId:s,newSource:n,metadata:o,type:i}=e,l=C(t[e.originalCellId],n);if(l)return{originalCellId:s,cellModel:l,metadata:o,type:i}}}class S{constructor(){this._isDisposed=!1,this._managers=new Map,this._managerChanged=new n.Signal(this),this._managerRegistered=new n.Signal(this)}get isDisposed(){return this._isDisposed}get managerChanged(){return this._managerChanged}get managerRegistered(){return this._managerRegistered}async register(e){const{id:t,manager:s}=e;return this._managers.has(t)?(console.error(`Suggestions manager with id ${t} exists!`),!1):(this._managers.set(t,s),this._managerRegistered.emit(t),!0)}async setManager(e){return!!this._managers.has(e)&&(this._currentManager=this._managers.get(e),this._managerChanged.emit(this._currentManager),!0)}async getActivatedManager(){return this._currentManager}getAllManagers(){return[...this._managers.keys()]}dispose(){this._isDisposed||(this._managers.forEach((e=>e.dispose())),this._managers.clear())}}var M=s(345),k=s(628),I=s.n(k),y=s(386);const x=(0,y.iF)({height:"29px"}),P=(0,y.iF)({height:"auto",width:"max-content",color:"var(--jp-ui-font-color1)",textAlign:"justify",borderRadius:"6px",padding:"0 5px",position:"fixed",display:"table",visibility:"hidden",transform:"translateX(calc(-100% + 30px)) translateY(calc(30px))"}),E=(0,y.iF)({$nest:{"&:hover":{background:"var(--jp-layout-color2)"},"& > .lm-Menu-itemIcon":{display:"inline-block",verticalAlign:"middle",$nest:{"& > div":{display:"flex"}}}}}),D=(0,y.iF)({boxShadow:"inset 0px 0px 2px 2px var(--neutral-fill-hover)",background:"var(--jp-layout-color0)"}),A=(0,y.iF)({$nest:{"& path":{fill:"var(--jp-brand-color1)!important"}}}),T=M.forwardRef(((e,t)=>{const{left:s,top:n,executeAddSuggestion:o,executeAddDeleteCellSuggestion:l,open:a}=e;return I().createPortal(M.createElement("div",{style:{left:s,top:n,visibility:a?"visible":"hidden"},className:`lm-Menu ${P}`,ref:t},M.createElement("ul",{className:"lm-Menu-content"},M.createElement("li",{className:`${E} lm-Menu-item`},M.createElement("div",{className:"lm-Menu-itemIcon"},M.createElement(i.editIcon.react,null)),M.createElement("div",{onClick:o,style:{padding:0},className:"lm-Menu-itemLabel"},"Suggest change")),M.createElement("li",{className:`${E} lm-Menu-item`},M.createElement("div",{className:"lm-Menu-itemIcon"},M.createElement(i.deleteIcon.react,null)),M.createElement("div",{style:{padding:0},onClick:l,className:"lm-Menu-itemLabel"},"Suggest delete")))),document.body)})),j=M.memo((function(e){var t,s;const{commands:n,cell:o,suggestionModel:a}=e,[d,g]=M.useState(!1),c=M.useReducer((e=>e+1),0),[r,u]=M.useState({top:"0px",left:"0px"}),m=M.useRef(null),p=M.useRef(null),_=M.useCallback((()=>{if(m.current){const e=m.current.getBoundingClientRect(),t=e.left,s=e.top;u({left:`${t}px`,top:`${s}px`})}}),[]),v=M.useCallback((()=>{_(),g((e=>!e))}),[_]),C=M.useCallback((()=>{n.execute(h.addCellSuggestion),g(!1)}),[n]),f=M.useCallback((()=>{n.execute(h.addDeleteCellSuggestion),g(!1)}),[n]);M.useEffect((()=>{const e=e=>{const t=e.target;t&&(m.current&&m.current.contains(t)||p.current&&!p.current.contains(t)&&g(!1))};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}}),[m]);const b=(null===(t=null==o?void 0:o.model)||void 0===t?void 0:t.id)&&null!==(s=a.getCellSuggestions({cellId:o.model.id}))&&void 0!==s?s:{},w=Object.keys(b).length;return M.useEffect((()=>{const e=(e,t)=>{var s;t.cellId===(null===(s=null==o?void 0:o.model)||void 0===s?void 0:s.id)&&setTimeout((()=>{c[1]()}),0)};return a.suggestionChanged.connect(e),()=>{a.suggestionChanged.disconnect(e)}})),M.createElement("div",{ref:m,className:`${x} ${d?D:""}`},M.createElement(i.ToolbarButtonComponent,{icon:l,onClick:v,className:`${w?A:""}`,tooltip:"Suggestion menu"}),M.createElement(T,{ref:p,open:d,top:r.top,left:r.left,executeAddSuggestion:C,executeAddDeleteCellSuggestion:f}))}));class L extends i.ReactWidget{constructor(e){super(),this.options=e}render(){return M.createElement(j,{...this.options})}}class R{constructor(e){this._isDisposed=!1,this._notebookPanel=null,this._allSuggestionsChanged=new n.Signal(this),this._suggestionChanged=new n.Signal(this),this._activeCellChanged=new n.Signal(this),this._promiseQueue={},this._userManager=e.userManager,this.switchNotebook(e.panel),this.switchManager(e.suggestionsManager)}get sourceLiveUpdate(){var e;return Boolean(null===(e=this._suggestionsManager)||void 0===e?void 0:e.sourceLiveUpdate)}get filePath(){var e;return null!==(e=this._filePath)&&void 0!==e?e:""}get allSuggestionsChanged(){return this._allSuggestionsChanged}get activeCellChanged(){return this._activeCellChanged}get suggestionChanged(){return this._suggestionChanged}get currentNotebookPanel(){return this._notebookPanel}get isDisposed(){return this._isDisposed}get allSuggestions(){return this._allSuggestions}dispose(){var e;this._isDisposed||(this._isDisposed=!0,null===(e=this._suggestionsManager)||void 0===e||e.suggestionChanged.disconnect(this._handleSuggestionChanged),n.Signal.clearData(this))}getSuggestionManagerName(){var e,t;return null!==(t=null===(e=this._suggestionsManager)||void 0===e?void 0:e.name)&&void 0!==t?t:""}async addSuggestion(e){var t;const s=null===(t=this._notebookPanel)||void 0===t?void 0:t.content.activeCell;s&&this._notebookPanel&&this._suggestionsManager&&await this._suggestionsManager.addSuggestion({notebook:this._notebookPanel,cell:s,author:this._userManager.identity,type:e.type})}async deleteSuggestion(e){const{cellId:t,suggestionId:s}=e;t&&this._notebookPanel&&(this._suggestionsManager&&await this._suggestionsManager.deleteSuggestion({notebook:this._notebookPanel,cellId:t,suggestionId:s}),this._allSuggestions&&this._allSuggestions.has(t))&&delete this._allSuggestions.get(t)[s]}async acceptSuggestion(e){const{cellId:t,suggestionId:s}=e;if(t&&this._notebookPanel&&this._suggestionsManager){const e=await this._suggestionsManager.acceptSuggestion({notebook:this._notebookPanel,cellId:t,suggestionId:s});return e&&this._allSuggestions&&this._allSuggestions.has(t)&&delete this._allSuggestions.get(t)[s],e}return!1}async updateSuggestion(e){const{cellId:t,suggestionId:s,newSource:n}=e;t&&this._notebookPanel&&this._suggestionsManager&&await this._suggestionsManager.updateSuggestion({notebook:this._notebookPanel,cellId:t,suggestionId:s,newSource:n})}async getSuggestion(e){var t,s;if(!this._filePath||!this._suggestionsManager)return;const{cellId:n,suggestionId:o}=e;let i;if((null===(t=this._allSuggestions)||void 0===t?void 0:t.has(n))?i=this._allSuggestions.get(n):(i={},null===(s=this._allSuggestions)||void 0===s||s.set(n,i)),!i[o]){const t=await this._suggestionsManager.getSuggestion({notebookPath:this._filePath,...e}),s=this._convertSuggestionFromManager(t);s&&(i[o]=s)}return i[o]}getCellSuggestions(e){var t,s;if(!this._filePath||!this._suggestionsManager)return;const{cellId:n}=e;let o;return(null===(t=this._allSuggestions)||void 0===t?void 0:t.has(n))?o=this._allSuggestions.get(n):(o={},null===(s=this._allSuggestions)||void 0===s||s.set(n,o)),o}getActiveCell(){var e;return null===(e=this._notebookPanel)||void 0===e?void 0:e.content.activeCell}getCellIndex(e){var t,s;if(!e)return-1;const n=null===(s=null===(t=this._notebookPanel)||void 0===t?void 0:t.content.model)||void 0===s?void 0:s.cells;if(!n)return-1;for(let t=0;t<n.length;t++)if(n.get(t).id===e)return t;return-1}async switchNotebook(e){var t,s;if(e){await e.context.ready,this._disconnectPanelSignal(),this._notebookPanel=e,this._connectPanelSignal(),this._filePath=null===(t=this._notebookPanel)||void 0===t?void 0:t.context.localPath;const n=await(null===(s=this._suggestionsManager)||void 0===s?void 0:s.getAllSuggestions(e));this._allSuggestions=this._convertAllSuggestionsFromManager(n)}else this._allSuggestions=void 0;this._promiseQueue={},this._allSuggestionsChanged.emit()}async switchManager(e){var t,s;if(e&&(null===(t=this._suggestionsManager)||void 0===t||t.suggestionChanged.disconnect(this._handleSuggestionChanged),this._suggestionsManager=e,this._suggestionsManager.suggestionChanged.connect(this._handleSuggestionChanged,this),this._notebookPanel)){const e=await(null===(s=this._suggestionsManager)||void 0===s?void 0:s.getAllSuggestions(this._notebookPanel));this._allSuggestions=this._convertAllSuggestionsFromManager(e),this._promiseQueue={},this._allSuggestionsChanged.emit()}}scrollToCell(e){if(e&&this._notebookPanel){const t=this.getCellIndex(e);if(-1!==t){const s=this._notebookPanel.content._findCellById(e);s&&(this._notebookPanel.content.activeCellIndex=t,this._notebookPanel.content.scrollToCell(s.cell))}}}_convertSuggestionFromManager(e){if(!e||!this._notebookPanel)return;const{originalCellId:t,metadata:s,cellModel:n,type:o}=e,i=this._notebookPanel.context.model.cells;for(const e of i)if(e.id===t){let t;return t=o===f.delete||null===n?C(e):n,{cellModel:t,originalCellModel:e,metadata:s,type:o}}}_convertAllSuggestionsFromManager(e){if(!e||!this._notebookPanel)return;const t=new Map;return e.forEach(((e,s)=>{const n={};for(const t in e){const s=this._convertSuggestionFromManager(e[t]);s&&(n[t]=s)}t.set(s,n)})),t}_connectPanelSignal(){var e;this._notebookPanel&&(this._notebookPanel.content.activeCellChanged.connect(this._handleActiveCellChanged,this),null===(e=this._notebookPanel.content.model)||void 0===e||e.sharedModel.changed.connect(this._handleNotebookChanged,this))}_disconnectPanelSignal(){this._notebookPanel&&this._notebookPanel.content.activeCellChanged.disconnect(this._handleActiveCellChanged)}_handleActiveCellChanged(e,t){this._activeCellChanged.emit({cellId:null==t?void 0:t.model.id})}async _handleNotebookChanged(e,t){var s,n,o,i,l,a;const d=p(t);if(d){const{event:e}=d,t=m(this._notebookPanel);if("deleted"===e){const e=new Set(Object.keys(t)),l=[...null!==(n=null===(s=this._allSuggestions)||void 0===s?void 0:s.keys())&&void 0!==n?n:[]].filter((t=>!e.has(t)));for(const e of l){const t=Object.keys(null!==(i=null===(o=this._allSuggestions)||void 0===o?void 0:o.get(e))&&void 0!==i?i:{});for(const s of t)await this.deleteSuggestion({cellId:e,suggestionId:s})}}if("moved"===e){const e=null!==(l=d.movedCells)&&void 0!==l?l:[];let s=!1;for(const n of e){const e=n.id;this._promiseQueue[e]||(this._promiseQueue[e]=new r.PromiseDelegate);const o=this._promiseQueue[e];if(null===(a=this._allSuggestions)||void 0===a?void 0:a.has(e)){const n=this._allSuggestions.get(e),i=Object.entries(n),l=t[e];let a=!1;l&&i.length>0&&(s=!0,i.forEach((([e,t])=>{t.originalCellModel=l,a=t.cellModel.sharedModel.isStandalone})),a&&await o.promise)}delete this._promiseQueue[e]}s&&this._allSuggestionsChanged.emit()}}}_handleSuggestionChanged(e,t){var s,n;const{notebookPath:o,...i}=t;if(o===this._filePath)if("modified"===t.operator){const{cellId:e,suggestionId:n,modifiedData:o}=t;if(null===(s=this._allSuggestions)||void 0===s?void 0:s.has(e)){const t=this._allSuggestions.get(e)[n];t&&o&&(o.cellModel&&(t.cellModel=o.cellModel),o.metadata&&(t.metadata=o.metadata))}this._promiseQueue[e]||(this._promiseQueue[e]=new r.PromiseDelegate),this._promiseQueue[e].resolve()}else{if("deleted"===t.operator){const{cellId:e,suggestionId:s}=t;(null===(n=this._allSuggestions)||void 0===n?void 0:n.has(e))&&delete this._allSuggestions.get(e)[s]}this._suggestionChanged.emit(i)}}}var N=s(256);class z extends N.Widget{constructor(){super({node:F()}),this.title.changed.connect((e=>{this.node.textContent=this.title.label}))}}function F(){const e=document.createElement("h2");return e.textContent="-",e}const W=(0,y.iF)({}),B=(0,y.iF)({display:"flex",flexDirection:"column",gap:"5px",height:"100%",overflow:"auto"});var $=s(594),U=s(964);const O=(0,y.iF)({height:"26px",borderBottom:"var(--jp-border-width) solid var(--jp-toolbar-border-color)",boxShadow:"var(--jp-toolbar-box-shadow)",background:"var(--jp-toolbar-background)",display:"flex",flexDirection:"row-reverse"}),q=(0,y.iF)({margin:"0px!important"}),Q=(0,y.iF)({background:"var(--jp-cell-editor-background)",margin:"5px",border:"var(--jp-border-width) solid var(--jp-cell-editor-border-color)",$nest:{".minimize":{height:0,overflow:"hidden",padding:"0!important"}}}),H=(0,y.iF)({$nest:{"> div":{border:"var(--jp-border-width) solid var(--jp-cell-editor-active-border-color)!important",boxShadow:"var(--jp-elevation-z4)"}}}),Z={content:'""',position:"absolute",top:0,left:0,width:"100%",height:"100%",backgroundRepeat:"no-repeat",backgroundSize:"100% 100%",pointerEvents:"none"},V=(0,y.iF)({$nest:{"&::before":{...Z,backgroundImage:`url("data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" preserveAspectRatio="none" viewBox="0 0 100 100">\n  <path d="M100 0 L0 100" stroke="red" stroke-width="1" vector-effect="non-scaling-stroke" />\n  <path d="M0 0 L100 100" stroke="red" stroke-width="1" vector-effect="non-scaling-stroke" />\n</svg>')}")`,zIndex:2e3},"&::after":{...Z,backgroundColor:"#ff000012",zIndex:3e3}}});var Y=s(781),G=s(497),J=s(251);const X=M.memo((function(e){var t;const{toggleMinimized:s,state:n}=e,o=M.useCallback((()=>{s(!n.get("minimized"))}),[s,n]),[l,a]=M.useState({minimized:n.get("minimized")});M.useEffect((()=>{const e=()=>{const e=n.get("minimized");a((t=>({...t,minimized:e})))};return n.changed.connect(e),()=>{n.changed.disconnect(e)}}),[n]);const r=null===(t=e.metadata)||void 0===t?void 0:t.author;return M.createElement("div",{className:O},r&&M.createElement("div",{title:r.display_name,className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon",style:{backgroundColor:r.color}},M.createElement("span",null,r.initials)),M.createElement($.ToolbarButtonComponent,{className:q,icon:i.closeIcon,onClick:e.deleteCallback,iconLabel:"Delete"}),M.createElement($.ToolbarButtonComponent,{className:q,icon:i.checkIcon,onClick:e.acceptCallback,iconLabel:"Accept suggestion"}),M.createElement($.ToolbarButtonComponent,{className:q,icon:l.minimized?d:g,onClick:o,iconLabel:l.minimized?"Expand":"Collapse"}),M.createElement($.ToolbarButtonComponent,{className:q,icon:c,onClick:e.navigateCallback,iconLabel:"Navigate to cell"}))}));class K extends $.ReactWidget{constructor(e){super(),this.options=e}render(){return M.createElement(X,{...this.options})}}class ee extends N.Panel{constructor(e){super(e),this._state=new G.ObservableMap({values:{minimized:!1}});const{suggestionData:t,liveUpdate:s}=e,{originalCellModel:n,cellModel:o}=t;this.addClass(Q),this._cellId=null==o?void 0:o.id;const i=this._createCell(n,o,s);if(i){this._cellWidget=i;const s=new K({toggleMinimized:this.toggleMinimized.bind(this),deleteCallback:e.deleteCallback,acceptCallback:e.acceptCallback,navigateCallback:e.navigateCallback,state:this._state,metadata:t.metadata});this.addWidget(s),this.addWidget(this._cellWidget)}}get cellId(){return this._cellId}dispose(){var e,t;n.Signal.clearData(null===(e=this._cellWidget)||void 0===e?void 0:e.model),null===(t=this._cellWidget)||void 0===t||t.dispose(),super.dispose()}toggleMinimized(e){var t,s;this._state.set("minimized",e),e?null===(t=this._cellWidget)||void 0===t||t.addClass("minimize"):null===(s=this._cellWidget)||void 0===s||s.removeClass("minimize")}_cmExtensioRegistry(e,t){const s=new Y.EditorThemeRegistry;Y.EditorThemeRegistry.getDefaultThemes().forEach((e=>{s.addTheme(e)}));const n=new Y.EditorExtensionRegistry;return Y.EditorExtensionRegistry.getDefaultExtensions({themes:s}).forEach((e=>{n.addExtension(e)})),n.addExtension({name:"shared-model-binding",factory:e=>{const t=e.model.sharedModel;return Y.EditorExtensionRegistry.createImmutableExtension((0,Y.ybinding)({ytext:t.ysource}))}}),n}_cmLanguageRegistry(){const e=new Y.EditorLanguageRegistry;return Y.EditorLanguageRegistry.getDefaultLanguages().filter((e=>["ipython","julia","python"].includes(e.name.toLowerCase()))).forEach((t=>{e.addLanguage(t)})),e.addLanguage({name:"ipythongfm",mime:"text/x-ipythongfm",load:async()=>(await Promise.all([s.e(977),s.e(675)]).then(s.bind(s,977))).markdown({codeLanguages:t=>e.findBest(t)})}),e}_createCell(e,t,s){const n=new J.RenderMimeRegistry({initialFactories:J.standardRendererFactories}),o=new Y.CodeMirrorEditorFactory({extensions:this._cmExtensioRegistry(e,s),languages:this._cmLanguageRegistry()}),i=e.type,l=new u.Cell.ContentFactory({editorFactory:o.newInlineEditor.bind(o)}),a={lineNumbers:!1,lineWrap:!1,matchBrackets:!0,tabFocusable:!1};let d;switch(i){case"code":d=new u.CodeCell({contentFactory:l,rendermime:n,model:t,editorConfig:a}).initializeState(),d.outputArea.setHidden(!0);break;case"markdown":d=new u.MarkdownCell({contentFactory:l,rendermime:n,model:t,editorConfig:a}).initializeState(),d.rendered=!1;break;case"raw":d=new u.RawCell({contentFactory:l,model:t,editorConfig:a}).initializeState()}return d}}var te=s(24),se=s(195),ne=s(4);class oe{constructor(e,t){this._view=e,this.decorations=te.Decoration.none,this._originalCell=t.originalCell,this._debouncedUpdate=new U.Debouncer(this.originalCellUpdated.bind(this),500),t.liveUpdate&&this._originalCell.sharedModel.changed.connect(this._debouncedUpdate.invoke,this._debouncedUpdate),this.updateDecorations()}update(e){(e.docChanged||e.selectionSet)&&this.updateDecorations()}originalCellUpdated(){this.updateDecorations(),this._view.dispatch({effects:se.StateEffect.appendConfig.of([])})}updateDecorations(){const e=this._view.state.doc.toString(),t=this._originalCell.sharedModel.getSource(),s=ne.pR(t,e),n=[];let o=0;for(const e of s){const t=e.value.length;e.added?(n.push(te.Decoration.mark({class:"cm-cell-diff-added"}).range(o,o+t)),o+=t):e.removed?n.push(te.Decoration.widget({widget:new ie(e.value),side:-1}).range(o,o)):o+=t}this.decorations=te.Decoration.set(n)}destroy(){this._originalCell.sharedModel.changed.disconnect(this._debouncedUpdate.invoke)}}class ie extends te.WidgetType{constructor(e){super(),this._text=e}get text(){return this._text}toDOM(){const e=document.createElement("span");return e.textContent=this._text,e.className="cm-cell-diff-removed",e}eq(e){return e instanceof ie&&e.text===this.text}updateDOM(){return!1}}function le(e){return te.ViewPlugin.fromClass(class extends oe{constructor(t){super(t,e)}},{decorations:e=>e.decorations})}class ae extends ee{constructor(e){super(e)}_cmExtensioRegistry(e,t){const s=super._cmExtensioRegistry(e,t);return s.addExtension({name:"suggestion-view",factory:s=>Y.EditorExtensionRegistry.createImmutableExtension([le({originalCell:e,liveUpdate:t})])}),s}}class de extends ee{constructor(e){super(e)}_createCell(e,t,s){const n=super._createCell(e,t,s);return null==n||n.addClass(V),n}}class ge extends i.PanelWithToolbar{constructor(e){super(e),this._suggestionsArea=new N.Panel,this._cellSuggestionsPanel=new Map,this.title.label="All Suggestions",this._model=e.model,this._suggestionsArea.addClass(B),this._suggestionsArea.addClass("jp-scrollbar-tiny"),this.addWidget(this._suggestionsArea),this._renderSuggestions(),this._model.suggestionChanged.connect(this._updateSuggestions,this),this._model.allSuggestionsChanged.connect(this._renderSuggestions,this),this._model.activeCellChanged.connect(this._handleActiveCellChanged,this)}dispose(){this._model.suggestionChanged.disconnect(this._updateSuggestions),this._model.allSuggestionsChanged.disconnect(this._renderSuggestions),this._model.activeCellChanged.disconnect(this._handleActiveCellChanged)}async _updateSuggestions(e,t){const{operator:s,cellId:n,suggestionId:o}=t;switch(s){case"added":{const e=await this._model.getSuggestion({cellId:n,suggestionId:o});if(e){const{widget:t}=this._widgetFactory({suggestionId:o,suggestionData:e}),s=this._model.getCellIndex(n);let i=this._cellSuggestionsPanel.get(n);if(!i){const e=new N.Panel;let t;i={panel:e,cellIndex:s},this._cellSuggestionsPanel.set(n,i);const o=[...this._cellSuggestionsPanel.values()].sort(((e,t)=>e.cellIndex-t.cellIndex));for(const e of o){if(!(e.cellIndex<s))break;t=e.panel}let l=0;t&&(l=this._suggestionsArea.widgets.indexOf(t)+1),this._suggestionsArea.insertWidget(l,e)}i.panel.addWidget(t),this._highlightCellSuggestions(n)}break}case"deleted":{const e=this._cellSuggestionsPanel.get(n);if(!e)break;const t=[...e.panel.widgets];for(const e of t)if(e.id===o){e.dispose(),e.parent=null;break}break}}this._updatePanelTitle()}_handleActiveCellChanged(e,t){const{cellId:s}=t;s&&this._highlightCellSuggestions(s)}_highlightCellSuggestions(e){this._cellSuggestionsPanel.forEach(((t,s)=>{const{panel:n}=t;if(s===e){let e;n.addClass(H);for(const t of n.widgets)t.toggleMinimized(!1),e=t;this._scrollToWidget(n,e)}else n.removeClass(H)}))}_scrollToWidget(e,t){if(!e||!t)return;const s=e.node.offsetTop,n=t.node.offsetTop;this._suggestionsArea.node.scrollTop=s+n}_renderSuggestions(){const e=this._model.allSuggestions;if(this._cellSuggestionsPanel.forEach((e=>{var t,s;const{panel:n}=e,o=[...n.widgets];for(const e of o)null===(t=n.layout)||void 0===t||t.removeWidget(e),e.dispose(),e.parent=null;n.dispose(),n.parent=null,null===(s=this._suggestionsArea.layout)||void 0===s||s.removeWidget(n)})),this._cellSuggestionsPanel.clear(),e){const t={};for(const[s,n]of e.entries()){const e=new N.Panel,o=this._model.getCellIndex(s);this._cellSuggestionsPanel.set(s,{panel:e,cellIndex:o}),t[o]=e,Object.entries(n).forEach((([t,s])=>{const{widget:n}=this._widgetFactory({suggestionId:t,suggestionData:s});e.addWidget(n)}))}const s=[...Object.keys(t)].sort(((e,t)=>parseInt(e)-parseInt(t)));for(const e of s)this._suggestionsArea.insertWidget(parseInt(e),t[e])}this._updatePanelTitle();const t=this._model.getActiveCell(),s=null==t?void 0:t.model.id;this._handleActiveCellChanged(this._model,{cellId:s})}_updatePanelTitle(){let e=0;this._cellSuggestionsPanel.forEach((t=>{e+=t.panel.widgets.length})),this.title.label=0!==e?`All Suggestions (${e})`:"All Suggestions"}_widgetFactory(e){const{suggestionId:t,suggestionData:s}=e,n=s.originalCellModel.id,o=new U.Debouncer((async e=>{const s=e.toJSON();await this._model.updateSuggestion({cellId:n,suggestionId:t,newSource:s.source})}),500);s.cellModel.sharedModel.changed.connect((async(e,t)=>{o.invoke(e)})),s.cellModel.sharedModel.disposed.connect((()=>{o.dispose()}));let i=ee;switch(s.type){case f.change:i=ae;break;case f.delete:i=de}const l=new i({suggestionData:s,deleteCallback:async()=>{const{button:e}=await(0,$.showDialog)({title:"Discard suggestion",body:"Do you want to discard the suggestion?",buttons:[$.Dialog.cancelButton(),$.Dialog.okButton()],hasClose:!0});e.accept&&await this._model.deleteSuggestion({cellId:n,suggestionId:t})},acceptCallback:async()=>{if(!await this._model.acceptSuggestion({cellId:n,suggestionId:t})){const{button:e}=await(0,$.showDialog)({title:"Error accepting suggestion",body:"Cannot accept suggestion, do you want to discard it?",buttons:[$.Dialog.cancelButton(),$.Dialog.okButton()],hasClose:!0});e.accept&&await this._model.deleteSuggestion({cellId:n,suggestionId:t})}},navigateCallback:async()=>{this._model.scrollToCell(n)},liveUpdate:this._model.sourceLiveUpdate});return l.id=t,{widget:l}}}class ce extends i.SidePanel{constructor(e){super(e),this._headerWidget=new z,this.addClass(W),this.node.tabIndex=0,this._model=e.model,this.header.addWidget(this._headerWidget),this.connectSignal(),this._handleAllSuggestionsChanged();const t=new ge({model:this._model});this.addWidget(t)}connectSignal(){this._model.allSuggestionsChanged.connect(this._handleAllSuggestionsChanged,this)}disconnectSignal(){this._model.allSuggestionsChanged.disconnect(this._handleAllSuggestionsChanged),n.Signal.clearData(this)}dispose(){this.isDisposed||(this.disconnectSignal(),super.dispose())}_handleAllSuggestionsChanged(){const e=this._model.filePath,t=this._model.getSuggestionManagerName();this._headerWidget.title.label=`${t} - ${e}`}}const re=new r.Token("jupyter-suggestions:suggestionsModel"),ue=new r.Token("jupyter-suggestions:suggestionsManagerRegistry")}}]);