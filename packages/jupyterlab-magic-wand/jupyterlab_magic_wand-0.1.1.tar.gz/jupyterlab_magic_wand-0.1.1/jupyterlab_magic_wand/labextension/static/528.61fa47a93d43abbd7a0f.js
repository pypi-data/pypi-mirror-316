"use strict";(self.webpackChunkjupyterlab_magic_wand=self.webpackChunkjupyterlab_magic_wand||[]).push([[528],{528:(e,t,n)=>{n.r(t),n.d(t,{default:()=>k});var l=n(338),o=n(228),i=n(262),a=n(960);const s=new a.LabIcon({name:"want:Icon",svgstr:'<svg\n  viewBox="0 0 24 24"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161">\n    <path\n        d="M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.9959.9959 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"\n    ></path>\n  </g>\n</svg>'}),r=new a.LabIcon({name:"spinner:Icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><circle cx="4" cy="12" r="3" fill="currentColor"><animate id="svgSpinners3DotsFade0" fill="freeze" attributeName="opacity" begin="0;svgSpinners3DotsFade1.end-0.25s" dur="0.75s" values="1;0.2"/></circle><circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.4"><animate fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.15s" dur="0.75s" values="1;0.2"/></circle><circle cx="20" cy="12" r="3" fill="currentColor" opacity="0.3"><animate id="svgSpinners3DotsFade1" fill="freeze" attributeName="opacity" begin="svgSpinners3DotsFade0.begin+0.3s" dur="0.75s" values="1;0.2"/></circle></svg>'});new a.LabIcon({name:"thumbUp:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161" fill-opacity="0" stroke="#616161" stroke-width="2px">\n    <path\n        d="M1 21h4V9H1zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73z"\n    ></path>\n  </g>\n</svg>'}),new a.LabIcon({name:"thumbDown:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161" fill-opacity="0" stroke="#616161" stroke-width="2px">\n    <path\n        d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2m4 0v12h4V3z"\n    ></path>\n  </g>\n</svg>'}),new a.LabIcon({name:"feedback:Icon",svgstr:'<svg\n  viewBox="0 0 28 28"\n  version="1.1"\n  xmlns="http://www.w3.org/2000/svg"\n  xmlns:xlink="http://www.w3.org/1999/xlink"\n>\n  <g class="jp-icon3" fill="#616161">\n    <path\n        d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m0 14H5.17l-.59.59-.58.58V4h16zm-9.5-2H18v-2h-5.5zm3.86-5.87c.2-.2.2-.51 0-.71l-1.77-1.77c-.2-.2-.51-.2-.71 0L6 11.53V14h2.47z"\n    ></path>\n  </g>\n</svg>'});var c=n(602),d=n(963);function u(e){const t=null==e?void 0:e.model.sharedModel.getSource();null==e||e.model.selections;let n=null;if("code"===(null==e?void 0:e.model.type)){const t=e,l=t.outputArea.model.length-1,o=t.outputArea.model.get(l);if(o&&"error"===o.type){const e=o.data["application/vnd.jupyter.error"];e&&(n=e.ename+": "+e.evalue)}}return{cell_id:null==e?void 0:e.model.sharedModel.getId(),type:null==e?void 0:e.model.type,error:n,source:t}}function g(e,t){var n,l,o;const i=null===(l=null===(n=e.model)||void 0===n?void 0:n.cells.get(t))||void 0===l?void 0:l.id;if(i){const t=null===(o=e._findCellById(i))||void 0===o?void 0:o.cell;if(t)return t}}var m=n(597),v=n(358),h=n(213),p=n(345);const w=new i.Token("AICellTracker");class b{constructor(e,t,n,l){this.commandId="jupyterlab_magic_wand:improve-cell",this.eventSchemaId="https://events.jupyter.org/jupyter_ai/magic_button/v1",this.pendingCells=new Map,this._responseHappened=new c.Signal(this),this._notebookTracker=t,this._eventListener=n,this._commandRegistry=e,this._cellFooterTracker=l,this._eventListener.addListener(this.eventSchemaId,(async(e,t,n)=>{await this.response(n)})),this._eventListener.addListener("https://events.jupyter.org/jupyter_ai/error/v1",(async(e,t,n)=>{const l=n;this.pendingCells.delete(l.reply_to),this._commandRegistry.notifyCommandChanged(this.commandId);const{cell:o}=this.findCell(l.reply_to);null==o||o.model.setMetadata("editable",!0),null==o||o.saveEditableState(),h.Notification.error("An error occurred with the AI Magic button.",{autoClose:5e3,actions:[{label:"Read more",callback:()=>{var e,t;e=l.error_type,t=l.message,(0,h.showDialog)({title:p.createElement("div",{className:"jp-MagicDialog-header"},p.createElement(s.react,{tag:"div",className:"jp-MagicDialog-icon"}),p.createElement("div",{className:"jp-MagicDialog-title"},"Oops! ",e)),body:p.createElement("div",null,p.createElement("p",null),p.createElement("pre",{className:"jp-MagicDialog-code"},p.createElement("code",null,t)),p.createElement("p",null,"We recommend that you try again. If the problem persists, please open an issue on Github!")),buttons:[h.Dialog.okButton()]})}}]})})),this._commandRegistry.addCommand(this.commandId,{label:e=>this.label(),icon:e=>(console.log("seen?"),this.icon(e)),execute:e=>this.execute(),isEnabled:e=>this.isEnabled()}),this.responseHappened.connect((()=>{this._commandRegistry.notifyCommandChanged(this.commandId)}))}async response(e){const t=e,n=t.context.cell_id;if(n){const e=this.pendingCells.get(n);e&&clearTimeout(e);const{cell:l}=this.findCell(n);null==l||l.model.setMetadata("editable",!0),null==l||l.saveEditableState(),this.pendingCells.delete(n);const o={...null==l?void 0:l.model.getMetadata("jupyter_ai"),agent:t.agent,messages:t.messages};null==l||l.model.setMetadata("jupyter_ai",o),l&&this._cellFooterTracker.showFooter(n),this._responseHappened.emit({cell:l,response:t})}t.commands&&t.commands.forEach((async e=>{try{await this._commandRegistry.execute(e.name,e.args)}catch(t){console.log("Could not execute AI command: "+e.name),console.error(t)}}))}get responseHappened(){return this._responseHappened}label(){console.log("SEEN label??");const e=this.getCurrentActiveCellId();return e&&e in this.pendingCells?"AI is thinking...":"AI, please help!"}icon(e){console.log("SEEN icon??");const t=this.getCurrentActiveCellId();return t&&this.pendingCells.get(t)?r:s}isEnabled(){console.log("SEEN enabled??");const e=this.getCurrentActiveCellId();return!e||!this.pendingCells.get(e)}getCurrentActiveCell(){var e,t;return console.log(null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCell),null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content.activeCell}getCurrentActiveCellId(){var e,t;console.log("getCurrentActiveCellId");const n=this._notebookTracker.currentWidget,l=null==n?void 0:n.content.activeCellIndex;if(void 0!==l&&n)return null===(t=null===(e=n.model)||void 0===e?void 0:e.cells.get(l))||void 0===t?void 0:t.id}findCell(e){var t,n;const l=this._notebookTracker.currentWidget,o=null===(n=null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content._findCellById(e))||void 0===n?void 0:n.cell;if(l&&o)return{cell:o,notebook:l};const i=this._notebookTracker.find((t=>{var n;return!!(null===(n=t.content._findCellById(e))||void 0===n?void 0:n.cell)}));return{cell:o,notebook:i}}async execute(){var e,t;const n=this._notebookTracker.currentWidget,l=function(e){const t=function(e){if(!(e instanceof d.DocumentWidget))return null;const{content:t}=e;return t instanceof o.Notebook?t:null}(e);if(!t)return null;const n=t.activeCellIndex,l=t.activeCell;if(!l)return null;const i=u(l),a=g(t,n-1);let s=null;a&&(s=u(a));const r=g(t,n+1);let c=null;return r&&(c=u(r)),{previous:s,current:i,next:c}}(n),i=this.getCurrentActiveCell();if(null==i||i.model.setMetadata("editable",!1),null==i||i.saveEditableState(),!l)return void console.log("AI Command not focused on a cell.");const a=l.current.cell_id,r=setTimeout((()=>{console.log("AI request timed out."),this.pendingCells.delete(a),this._commandRegistry.notifyCommandChanged(this.commandId),h.Notification.warning("The AI Magic button timed out.",{autoClose:5e3,actions:[{label:"Read more",callback:()=>{var e;e=null==l?void 0:l.current.source,(0,h.showDialog)({title:p.createElement("div",{className:"jp-MagicDialog-header"},p.createElement(s.react,{tag:"div",className:"jp-MagicDialog-icon"}),p.createElement("div",{className:"jp-MagicDialog-title"},"Oops! The magic button timed out.")),body:p.createElement("div",null,p.createElement("p",null,"The magic button timed out in the cell with the following content:"),p.createElement("pre",{className:"jp-MagicDialog-code"},p.createElement("code",null,e)),p.createElement("p",null,"We recommend that you try again. If the problem persists, please open an issue on Github!")),buttons:[h.Dialog.okButton()]})}}]}),null==i||i.model.setMetadata("editable",!0),null==i||i.saveEditableState()}),18e5);this.pendingCells.set(a,r);const c=null===(e=null==i?void 0:i.model)||void 0===e?void 0:e.sharedModel.getSource();!async function(e="",t={}){const n=v.ServerConnection.makeSettings(),l=m.URLExt.join(n.baseUrl,e);let o;try{o=await v.ServerConnection.makeRequest(l,t,n)}catch(e){throw new v.ServerConnection.NetworkError(e)}let i=await o.text();if(i.length>0)try{i=JSON.parse(i)}catch(e){console.log("Not a JSON response body.",o)}if(!o.ok)throw new v.ServerConnection.ResponseError(o,i.message||i)}("/api/ai/magic",{method:"POST",body:JSON.stringify({input:c,context:{cell_id:a,content:null===(t=null==n?void 0:n.content.model)||void 0===t?void 0:t.toJSON()},commands:[]})}),this._commandRegistry.notifyCommandChanged(this.commandId)}}var y=n(51),f=n(249);const C="jupyterlab_magic_wand",k=[{id:C+":plugin",description:"A cell tracker for the magic wand button.",autoStart:!0,optional:[l.ISettingRegistry],requires:[o.INotebookTracker,y.IEventListener,f.ICellFooterTracker],provides:w,activate:async(e,t,n,l,o)=>(console.log(`Jupyter Magic Wand plugin extension activated: ${C}:tracker`),await e.serviceManager.ready,new b(e.commands,t,n,l))}]}}]);